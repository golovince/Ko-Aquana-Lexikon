<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>gloogl – Ko-Aquana Lexikon</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Ko-Aquana Font -->
  <style>
    @font-face {
      font-family: 'KoAquana';
      src: url('Ko_aquana-Regular.otf') format('opentype');
      font-weight: normal;
      font-style: normal;
    }

    :root {
      --bg: #020617;
      --bg-alt: #02081f;
      --surface: #020b2a;
      --surface-alt: #020e33;
      --accent: #22d3ee;
      --accent-soft: rgba(34, 211, 238, 0.15);
      --accent-strong: #7dd3fc;
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --border: #1f2937;
      --danger: #fb7185;
      --radius-lg: 14px;
      --radius-md: 10px;
      --shadow-soft: 0 18px 45px rgba(0,0,0,0.45);
      --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-sans);
      background: radial-gradient(circle at top, #0b1120 0, #020617 60%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem 1.25rem 3rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 1rem;
    }

    header h1 {
      font-size: 1.9rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      font-weight: 700;
      color: var(--accent-strong);
      margin: 0;
    }

    header h1 span.dot {
      color: var(--danger);
    }

    header p {
      margin: 0;
      font-size: 0.95rem;
      color: var(--text-muted);
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.6fr);
      gap: 1.5rem;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      background: linear-gradient(135deg, var(--surface), var(--surface-alt));
      border-radius: 18px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      padding: 1.2rem 1.25rem 1.4rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.75rem;
    }

    .panel-title {
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .panel-title-badge {
      font-size: 0.7rem;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      border: 1px solid var(--accent-soft);
      color: var(--accent-strong);
      background: rgba(15,23,42,0.85);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .panel-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .fieldset {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      margin-bottom: 0.35rem;
    }

    .fieldset label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
    }

    .input-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.85);
      color: var(--text);
      padding: 0.55rem 0.85rem;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    .input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34,211,238,0.6);
      background: rgba(15,23,42,0.95);
    }

    .input.korallisch {
      font-family: 'KoAquana', var(--font-sans);
      font-size: 1.9rem;
      letter-spacing: 0.06em;
    }

    textarea.input {
      border-radius: var(--radius-lg);
      resize: vertical;
      min-height: 4rem;
      line-height: 1.4;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid var(--accent);
      background: rgba(15,23,42,0.9);
      color: var(--accent-strong);
      font-size: 0.8rem;
      padding: 0.4rem 0.75rem;
      cursor: pointer;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease;
    }

    .btn:hover {
      background: var(--accent-soft);
      transform: translateY(-1px);
      box-shadow: 0 0 0 1px rgba(34,211,238,0.5);
    }

    .btn-secondary {
      border-color: var(--border);
      color: var(--text-muted);
      background: rgba(15,23,42,0.85);
    }

    .btn-secondary:hover {
      border-color: var(--accent-soft);
      color: var(--accent-strong);
    }

    .keyboard {
      margin-top: 0.4rem;
      padding: 0.5rem;
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top, var(--surface-alt), var(--surface));
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .key-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
    }

    .key {
      min-width: 1.7rem;
      padding: 0.25rem 0.3rem;
      border-radius: 8px;
      border: 1px solid rgba(15,23,42,0.9);
      background: rgba(15,23,42,0.9);
      color: var(--accent-strong);
      font-family: 'KoAquana', var(--font-sans);
      font-size: 2rem;
      text-align: center;
      cursor: pointer;
      transition: background 0.1s ease, transform 0.08s ease, border-color 0.1s ease;
    }

    .key:hover {
      background: var(--accent-soft);
      border-color: var(--accent);
      transform: translateY(-1px);
    }

    .key.special {
      font-size: 0.7rem;
      font-family: var(--font-sans);
      color: var(--text-muted);
      min-width: 2.4rem;
    }

    .results {
      margin-top: 0.3rem;
      padding-top: 0.4rem;
      border-top: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      max-height: 20rem;
      overflow-y: auto;
    }

    .result-item {
      padding: 0.5rem 0.6rem;
      border-radius: var(--radius-md);
      background: rgba(15,23,42,0.85);
      border: 1px solid transparent;
      display: grid;
      grid-template-columns: minmax(0,1.4fr) minmax(0,1fr);
      gap: 0.25rem 0.75rem;
      align-items: center;
    }

    .result-item:hover {
      border-color: var(--accent-soft);
      background: radial-gradient(circle at left, rgba(34,211,238,0.08), rgba(15,23,42,0.95));
    }

    .result-main {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }

    .lemma-row {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 0.4rem;
    }

    .lemma-roman {
      font-weight: 600;
      font-size: 0.98rem;
    }

    .lemma-coral {
      font-family: 'KoAquana', var(--font-sans);
      font-size: 1.05rem;
      letter-spacing: 0.05em;
      color: var(--accent-strong);
    }

    .lemma-meta {
      font-size: 0.72rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .gloss {
      font-size: 0.86rem;
      color: var(--text-muted);
    }

    .result-side {
      font-size: 0.78rem;
      color: var(--text-muted);
      text-align: right;
    }

    footer {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.25rem 1.5rem;
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      opacity: 0.75;
    }

    footer a {
      color: var(--accent-strong);
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }

    .coral {
  font-family: "KoAquana";
}
.big {
  font-size: 2.5rem;
}
.hidden {
  display: none;
}

    .detail-coral {
  font-family: 'KoAquana', var(--font-sans);
  font-size: 2.6rem;
  letter-spacing: 0.08em;
  color: var(--accent-strong);
  line-height: 1.1;
  padding: 0.4rem 0.6rem;
  border-radius: var(--radius-lg);
  border: 1px solid var(--border);
  background: rgba(15,23,42,0.75);
  display: inline-block;
  margin-bottom: 0.6rem;
}

.detail-row {
  display: flex;
  gap: 0.6rem;
  align-items: baseline;
  margin: 0.25rem 0;
}

.detail-label {
  width: 7.5rem;
  font-size: 0.75rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.12em;
}

.detail-value {
  font-size: 0.95rem;
  color: var(--text);
  word-break: break-word;
}

.detail-h3 {
  margin: 0.5rem 0 0.35rem;
  font-size: 0.95rem;
  font-weight: 650;
  color: var(--text);
}

.detail-list {
  margin: 0;
  padding-left: 1.15rem;
  color: var(--text-muted);
  font-size: 0.92rem;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.detail-text {
  border: 1px solid var(--border);
  background: rgba(15,23,42,0.75);
  border-radius: var(--radius-lg);
  padding: 0.65rem 0.75rem;
  color: var(--text-muted);
  font-size: 0.92rem;
  line-height: 1.4;
}

/* Flexionstabelle */
.inflection-card {
  border: 1px solid var(--border);
  background: rgba(15,23,42,0.75);
  border-radius: 16px;
  padding: 0.75rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.inflection-meta {
  display: flex;
  gap: 0.6rem;
  flex-wrap: wrap;
  color: var(--text-muted);
  font-size: 0.78rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

.inflection-table {
  width: 100%;
  border-collapse: collapse;
  overflow: hidden;
  border-radius: 14px;
  border: 1px solid var(--border);
}

.inflection-table th,
.inflection-table td {
  padding: 0.5rem 0.55rem;
  border-bottom: 1px solid rgba(31,41,55,0.8);
  vertical-align: top;
  font-size: 0.9rem;
}

.inflection-table th {
  text-align: left;
  color: var(--text-muted);
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  background: rgba(2, 6, 23, 0.35);
}

.inflection-table tr:last-child td {
  border-bottom: none;
}

.cell-coral {
  font-family: 'KoAquana', var(--font-sans);
  font-size: 1.05rem;
  letter-spacing: 0.06em;
  color: var(--accent-strong);
}

.cell-muted {
  color: var(--text-muted);
  font-size: 0.85rem;
}

  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div>
        <h1>gloogl<span class="dot">·</span></h1>
        <p>Ko-Aquana → Deutsch Lexikon &amp; Schrift-Konverter</p>
      </div>
      <p>Sprache: Ko-Aquana · Ausgabe: romanisiert, korallisch, IPA</p>
    </header>

    <main>
      <!-- LINKSPANEL: Lexikon-Suche -->
      <section class="panel" id="lexikon-panel">
        <div class="panel-header">
          <div class="panel-title">
            Lexikon
            <span class="panel-title-badge">Nachschlagen</span>
          </div>
          <div class="panel-subtitle">
            Suche im Ko-Aquana-Wortschatz und zeige Übersetzungen an.
          </div>
        </div>

        <!-- Romanisierte Suche -->
        <div class="fieldset">
          <label for="search-roman">Suche (romanisiert)</label>
          <div class="input-row">
            <input
              id="search-roman"
              class="input"
              type="text"
              placeholder="z. B. groshz, gloogl, fshoolesh …"
            />
            <button class="btn btn-secondary" type="button" id="btn-clear-roman">
              löschen
            </button>
          </div>
        </div>

        <!-- Korallische Suche -->
        <div class="fieldset">
          <label for="search-coral">Suche (korallisch)</label>
          <div class="input-row">
            <input
              id="search-coral"
              class="input korallisch"
              type="text"
              placeholder=""
            />
            <button class="btn btn-secondary" type="button" id="btn-clear-coral">
              löschen
            </button>
          </div>

          <!-- Bildschirm-Tastatur 1 (für Suchfeld) -->
          <div class="keyboard" data-target="search-coral">
            <div class="key-row">
              <!-- Konsonanten -->
              <button class="key" type="button">q</button>
              <button class="key" type="button">w</button>
              <button class="key" type="button">r</button>
              <button class="key" type="button">t</button>
              <button class="key" type="button">z</button>
              <button class="key" type="button">p</button>
              <button class="key" type="button">s</button>
              <button class="key" type="button">d</button>
              <button class="key" type="button">f</button>
              <button class="key" type="button">g</button>
              <button class="key" type="button">h</button>
              <button class="key" type="button">k</button>
              <button class="key" type="button">l</button>
              <button class="key" type="button">y</button>
              <button class="key" type="button">x</button>
              <button class="key" type="button">c</button>
              <button class="key" type="button">v</button>
              <button class="key" type="button">b</button>
            </div>
            <div class="key-row">
              <!-- Vokale -->
              <button class="key" type="button">a</button>
              <button class="key" type="button">e</button>
              <button class="key" type="button">i</button>
              <button class="key" type="button">o</button>
              <button class="key" type="button">u</button>
              <button class="key" type="button">ü</button>
              <button class="key" type="button">j</button>
              <button class="key" type="button">ö</button>
              <button class="key" type="button">m</button>
              <button class="key" type="button">ä</button>
            </div>
            <div class="key-row">
              <!-- Sondertasten -->
              <button class="key special" type="button" data-special="space">␣</button>
              <button class="key special" type="button" data-special="comma">,</button>
              <button class="key special" type="button" data-special="end">⋯</button>
              <button class="key special" type="button" data-special="backspace">←</button>
            </div>
          </div>
        </div>

        <!-- Suchergebnisse -->
        <div class="results" id="results">
          <!-- Wird per JS befüllt -->
        </div>
        <!-- Detailansicht -->
<section class="panel" id="detail-panel" style="display:none;">
  <div class="panel-header">
    <div class="panel-title">
      Detailansicht
      <span class="panel-title-badge">Lexem</span>
    </div>
    <div class="panel-subtitle" id="detail-subtitle">—</div>
  </div>

  <div style="display:flex; gap:0.75rem; align-items:flex-start; flex-wrap:wrap;">
    <div style="flex: 1 1 300px;">
      <div id="detail-coral" class="detail-coral"></div>
      <div class="detail-row">
        <span class="detail-label">Romanisiert</span>
        <span id="detail-roman" class="detail-value"></span>
      </div>
      <div class="detail-row">
        <span class="detail-label">IPA</span>
        <span id="detail-ipa" class="detail-value"></span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Wortart</span>
        <span id="detail-pos" class="detail-value"></span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Domänen</span>
        <span id="detail-domains" class="detail-value"></span>
      </div>
    </div>

    <div style="flex: 1 1 340px;">
      <h3 class="detail-h3">Bedeutung (DE)</h3>
      <ul id="detail-gloss" class="detail-list"></ul>
    </div>
  </div>

  <div id="detail-notes-wrap" style="display:none;">
    <h3 class="detail-h3">Anmerkungen</h3>
    <div id="detail-notes" class="detail-text"></div>
  </div>

  <div id="detail-examples-wrap" style="display:none;">
    <h3 class="detail-h3">Beispiele</h3>
    <ul id="detail-examples" class="detail-list"></ul>
  </div>

  <!-- Flexionstabelle (immer sichtbar, wenn vorhanden) -->
  <div id="detail-inflection-wrap" style="display:none;">
    <h3 class="detail-h3">Flexion</h3>
    <div id="detail-inflection"></div>
  </div>

  <div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-top:0.5rem;">
    <button class="btn btn-secondary" type="button" id="btn-detail-close">Detailansicht schließen</button>
  </div>
</section>

      </section>

      <!-- RECHTSPANEL: Konverter -->
      <section class="panel" id="converter-panel">
        <div class="panel-header">
          <div class="panel-title">
            Schrift-Konverter
            <span class="panel-title-badge">Korallisch &amp; Romanisiert</span>
          </div>
          <div class="panel-subtitle">
            Wandle Ko-Aquana zwischen romanisierter und korallischer Schrift.
          </div>
        </div>

        <div class="fieldset">
          <label for="conv-roman">Ko-Aquana (romanisiert)</label>
          <textarea
            id="conv-roman"
            class="input"
            placeholder="z. B. Mbahsholesh shoglashesh fraleshglooshesh fshol …"
          ></textarea>
        </div>

        <div class="fieldset">
          <label for="conv-coral">Ko-Aquana (korallisch)</label>
          <textarea
            id="conv-coral"
            class="input korallisch"
            placeholder=""
          ></textarea>

          <!-- Bildschirm-Tastatur 2 (für Konverter) -->
          <div class="keyboard" data-target="conv-coral">
            <div class="key-row">
              <!-- Konsonanten -->
              <button class="key" type="button">q</button>
              <button class="key" type="button">w</button>
              <button class="key" type="button">r</button>
              <button class="key" type="button">t</button>
              <button class="key" type="button">z</button>
              <button class="key" type="button">p</button>
              <button class="key" type="button">s</button>
              <button class="key" type="button">d</button>
              <button class="key" type="button">f</button>
              <button class="key" type="button">g</button>
              <button class="key" type="button">h</button>
              <button class="key" type="button">k</button>
              <button class="key" type="button">l</button>
              <button class="key" type="button">y</button>
              <button class="key" type="button">x</button>
              <button class="key" type="button">c</button>
              <button class="key" type="button">v</button>
              <button class="key" type="button">b</button>
            </div>
            <div class="key-row">
              <!-- Vokale -->
              <button class="key" type="button">a</button>
              <button class="key" type="button">e</button>
              <button class="key" type="button">i</button>
              <button class="key" type="button">o</button>
              <button class="key" type="button">u</button>
              <button class="key" type="button">ü</button>
              <button class="key" type="button">j</button>
              <button class="key" type="button">ö</button>
              <button class="key" type="button">m</button>
              <button class="key" type="button">ä</button>
            </div>
            <div class="key-row">
              <!-- Sondertasten -->
              <button class="key special" type="button" data-special="space">␣</button>
              <button class="key special" type="button" data-special="comma">,</button>
              <button class="key special" type="button" data-special="end">⋯</button>
              <button class="key special" type="button" data-special="backspace">←</button>
            </div>
          </div>
        </div>

        <div class="input-row">
          <button class="btn" type="button" id="btn-roman-to-coral">
            Romanisiert → Korallisch
          </button>
          <button class="btn" type="button" id="btn-coral-to-roman">
            Korallisch → Romanisiert
          </button>
          <button class="btn btn-secondary" type="button" id="btn-clear-converter">
            alles löschen
          </button>
        </div>
      </section>
    </main>
  </div>

  <footer>
    <span>gloogl · Ko-Aquana Lexikon</span>
    <span>Font: KoAquana (Ko_aquana-Regular.otf)</span>
  </footer>

  <!-- JavaScript -->
  <script>
/* ------------------ Mapping: Romanisiert ↔ Korallisch ------------------ */
const romanToCoral = {
  "fshz": "k","shzt": "r","shzf": "z","sht": "t","shz": "d","fsh": "v","sh": "s",
  "mb": "p","gs": "q","fs": "w","gr": "g","gl": "h","br": "c","bl": "b","bs": "y",
  "ng": "x","fr": "f","l": "l",
  "oo": "ü","ah": "m","ie": "j","oh": "ö","äh": "ä",
  "a": "a","e": "e","i": "i","o": "o","u": "u"
};

const romanKeysSorted = Object.keys(romanToCoral).sort((a,b)=>b.length-a.length);

const coralToRoman = {};
for (const [r, c] of Object.entries(romanToCoral)) coralToRoman[c] = r;

function romanToCoralStr(input) {
  let s = (input || "").normalize("NFC");
  let out = "";
  let i = 0;
  while (i < s.length) {
    const ch = s[i];
    if (ch === " " || ch === "\n") { out += "n"; i++; continue; }
    if (ch === ",") { out += "nn"; i++; continue; }
    if (ch === "." || ch === "?" || ch === "!") { out += "nnn"; i++; continue; }

    let matched = false;
    for (const key of romanKeysSorted) {
      if (s.startsWith(key, i)) {
        out += romanToCoral[key];
        i += key.length;
        matched = true;
        break;
      }
    }
    if (!matched) { out += ch; i++; }
  }
  return out;
}

function coralToRomanStr(input) {
  let s = (input || "").normalize("NFC");
  let out = "";
  let i = 0;
  while (i < s.length) {
    const ch = s[i];

    if (ch === "n") {
      if (s.startsWith("nnn", i)) { out += ". "; i += 3; continue; }
      if (s.startsWith("nn", i)) { out += ", "; i += 2; continue; }
      out += " ";
      i += 1;
      continue;
    }

    out += (coralToRoman[ch] || ch);
    i += 1;
  }
  return out;
}

/* ------------------ Bildschirm-Tastaturen ------------------ */
function attachKeyboardHandlers() {
  const keyboards = document.querySelectorAll(".keyboard");
  keyboards.forEach(kb => {
    const targetId = kb.getAttribute("data-target");
    const targetEl = document.getElementById(targetId);
    if (!targetEl) return;

    kb.addEventListener("click", (ev) => {
      const btn = ev.target.closest(".key");
      if (!btn) return;
      const special = btn.getAttribute("data-special");

      if (special === "space") insertAtCursor(targetEl, "n");
      else if (special === "comma") insertAtCursor(targetEl, "nn");
      else if (special === "end") insertAtCursor(targetEl, "nnn");
      else if (special === "backspace") backspaceAtCursor(targetEl);
      else insertAtCursor(targetEl, btn.textContent);

      targetEl.dispatchEvent(new Event("input", { bubbles: true }));
      targetEl.focus();
    });
  });
}

function insertAtCursor(el, text) {
  const start = el.selectionStart ?? el.value.length;
  const end = el.selectionEnd ?? el.value.length;
  el.value = el.value.slice(0, start) + text + el.value.slice(end);
  const newPos = start + text.length;
  el.selectionStart = el.selectionEnd = newPos;
}

function backspaceAtCursor(el) {
  const start = el.selectionStart ?? el.value.length;
  const end = el.selectionEnd ?? el.value.length;
  if (start === end && start > 0) {
    el.value = el.value.slice(0, start - 1) + el.value.slice(end);
    el.selectionStart = el.selectionEnd = start - 1;
  } else if (start !== end) {
    el.value = el.value.slice(0, start) + el.value.slice(end);
    el.selectionStart = el.selectionEnd = start;
  }
}

/* ------------------ Suchindex laden + suchen ------------------ */
let searchIndex = [];
let indexLoaded = false;
let indexError = null;

async function loadSearchIndex() {
  try {
    const res = await fetch("./data/index.json", { cache: "no-cache" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    searchIndex = data.entries || [];
    indexLoaded = true;
    indexError = null;
    renderResults([]);
  } catch (err) {
    console.error("Fehler beim Laden des Index:", err);
    indexLoaded = false;
    indexError = err;
    renderResults(null);
  }
}

function filterIndexByRoman(query) {
  const q = (query || "").trim().toLowerCase();
  if (!q || !indexLoaded) return [];
  return searchIndex.filter(e => (e.roman || "").toLowerCase().includes(q));
}

function filterIndexByCoral(query) {
  const q = (query || "").trim();
  if (!q || !indexLoaded) return [];

  // direkte Korallischsuche
  const direct = searchIndex.filter(e => (e.coral || "").includes(q));
  if (direct.length) return direct;

  // fallback: korallisch -> romanisiert
  const romanQ = coralToRomanStr(q).trim().toLowerCase();
  if (!romanQ) return [];
  return searchIndex.filter(e => (e.roman || "").toLowerCase().includes(romanQ));
}

function renderResults(entries) {
  const container = document.getElementById("results");
  container.innerHTML = "";

  if (indexError) {
    const div = document.createElement("div");
    div.className = "result-item";
    div.innerHTML = `<div class="result-main"><div class="gloss">
      Fehler beim Laden des Lexikon-Index. Bitte Seite neu laden oder Daten prüfen.
    </div></div>`;
    container.appendChild(div);
    return;
  }

  if (!indexLoaded) {
    const div = document.createElement("div");
    div.className = "result-item";
    div.innerHTML = `<div class="result-main"><div class="gloss">Index wird geladen …</div></div>`;
    container.appendChild(div);
    return;
  }

  if (!entries || entries.length === 0) {
    const div = document.createElement("div");
    div.className = "result-item";
    div.innerHTML = `<div class="result-main"><div class="gloss">Keine Treffer.</div></div>`;
    container.appendChild(div);
    return;
  }

  entries.forEach(e => {
    const item = document.createElement("div");
    item.className = "result-item";
    item.style.cursor = "pointer";
    item.addEventListener("click", () => loadDetail(e.id));

    item.innerHTML = `
      <div class="result-main">
        <div class="lemma-row">
          <span class="lemma-roman">${escapeHtml(e.roman || "")}</span>
          <span class="lemma-coral">${escapeHtml(e.coral || "")}</span>
          <span class="lemma-meta">${escapeHtml((e.pos || "").toUpperCase())}</span>
        </div>
        <div class="gloss">${escapeHtml(e.gloss_de_short || "")}</div>
      </div>
      <div class="result-side">
        <div>${escapeHtml(e.ipa || "")}</div>
        <div>${escapeHtml((e.domains || []).join(", "))}</div>
      </div>
    `;
    container.appendChild(item);
  });
}

/* ------------------ Detailansicht ------------------ */
async function loadDetail(id) {
  const panel = document.getElementById("detail-panel");
  panel.style.display = "block";
  document.getElementById("detail-subtitle").textContent = `Lade ${id} …`;

  try {
    const res = await fetch(`./data/entries/${id}.json`, { cache: "no-cache" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const detail = await res.json();
    renderDetail(detail);
    panel.scrollIntoView({ behavior: "smooth", block: "start" });
  } catch (err) {
    console.error("Fehler beim Laden der Detaildatei:", err);
    document.getElementById("detail-subtitle").textContent =
      `Fehler beim Laden: data/entries/${id}.json`;
  }
}

function renderDetail(detail) {
  const hw = detail.headword || {};
  const roman = hw.roman || detail.romanized || detail.lemma || "";
  const coral = hw.coral || detail.korallisch || "";
  const ipa = hw.ipa || detail.ipa || "";
  const pos = detail.pos || "";

  document.getElementById("detail-subtitle").textContent = detail.id ? `ID: ${detail.id}` : "—";
  document.getElementById("detail-coral").textContent = coral || "—";
  document.getElementById("detail-roman").textContent = roman || "—";
  document.getElementById("detail-ipa").textContent = ipa || "—";
  document.getElementById("detail-pos").textContent = pos || "—";

  // Domains
  const domains = detail.domain || detail.domains || [];
  document.getElementById("detail-domains").textContent =
    Array.isArray(domains) && domains.length ? domains.join(", ") : "—";

  // Gloss
  const glossEl = document.getElementById("detail-gloss");
  glossEl.innerHTML = "";
  const gloss = detail.gloss_de;

  if (Array.isArray(gloss) && gloss.length) {
    gloss.forEach(g => {
      const li = document.createElement("li");
      li.textContent = g;
      glossEl.appendChild(li);
    });
  } else if (typeof gloss === "string" && gloss.trim()) {
    const li = document.createElement("li");
    li.textContent = gloss;
    glossEl.appendChild(li);
  } else {
    const li = document.createElement("li");
    li.textContent = "—";
    glossEl.appendChild(li);
  }

  // Notes
  const notesWrap = document.getElementById("detail-notes-wrap");
  const notesEl = document.getElementById("detail-notes");
  const notes = detail.notes;
  let notesText = "";
  if (Array.isArray(notes)) notesText = notes.join("\n");
  else if (typeof notes === "string") notesText = notes;

  if (notesText.trim()) {
    notesWrap.style.display = "block";
    notesEl.textContent = notesText;
  } else {
    notesWrap.style.display = "none";
    notesEl.textContent = "";
  }

  // Examples
  const exWrap = document.getElementById("detail-examples-wrap");
  const exEl = document.getElementById("detail-examples");
  exEl.innerHTML = "";
  const examples = detail.examples || (detail.usage && detail.usage.examples) || [];

  if (Array.isArray(examples) && examples.length) {
    exWrap.style.display = "block";
    examples.forEach(ex => {
      const ko = ex.ko || ex.ko_roman || "";
      const de = ex.de || "";
      const li = document.createElement("li");
      li.innerHTML = `<span class="cell-muted">${escapeHtml(ko)}</span> — ${escapeHtml(de)}`;
      exEl.appendChild(li);
    });
  } else {
    exWrap.style.display = "none";
  }

  // Inflection (present)
  const inflWrap = document.getElementById("detail-inflection-wrap");
  const inflEl = document.getElementById("detail-inflection");
  inflEl.innerHTML = "";

  const present = detail.inflection && detail.inflection.present;
  if (present && present.forms) {
    inflWrap.style.display = "block";
    inflEl.appendChild(renderInflectionPresent(present));
  } else {
    inflWrap.style.display = "none";
  }
}

function renderInflectionPresent(present) {
  const card = document.createElement("div");
  card.className = "inflection-card";

  const meta = document.createElement("div");
  meta.className = "inflection-meta";
  meta.textContent = `Präsens · ${present.type || "—"}`;
  card.appendChild(meta);

  const table = document.createElement("table");
  table.className = "inflection-table";
  table.innerHTML = `
    <thead>
      <tr>
        <th>Person</th>
        <th>Romanisiert</th>
        <th>Korallisch</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;

  const tbody = table.querySelector("tbody");
  const rows = [
    ["1sg", "1. Sg."],
    ["2sg", "2. Sg."],
    ["3sg", "3. Sg."],
    ["1pl", "1. Pl."],
    ["2pl", "2. Pl."],
    ["3pl", "3. Pl."],
  ];

  rows.forEach(([key, label]) => {
    const f = present.forms[key] || {};
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="cell-muted">${label}</td>
      <td>${escapeHtml(f.roman || "—")}</td>
      <td class="cell-coral">${escapeHtml(f.coral || "—")}</td>
    `;
    tbody.appendChild(tr);
  });

  card.appendChild(table);
  return card;
}

/* ------------------ Setup: Suche + Konverter + Close ------------------ */
function setupSearch() {
  const inputRoman = document.getElementById("search-roman");
  const inputCoral = document.getElementById("search-coral");
  const btnClearRoman = document.getElementById("btn-clear-roman");
  const btnClearCoral = document.getElementById("btn-clear-coral");

  inputRoman.addEventListener("input", () => renderResults(filterIndexByRoman(inputRoman.value)));
  inputCoral.addEventListener("input", () => renderResults(filterIndexByCoral(inputCoral.value)));

  btnClearRoman.addEventListener("click", () => {
    inputRoman.value = "";
    renderResults([]);
    inputRoman.focus();
  });

  btnClearCoral.addEventListener("click", () => {
    inputCoral.value = "";
    renderResults([]);
    inputCoral.focus();
  });

  renderResults([]);
}

function setupConverter() {
  const taRoman = document.getElementById("conv-roman");
  const taCoral = document.getElementById("conv-coral");
  const btnR2C = document.getElementById("btn-roman-to-coral");
  const btnC2R = document.getElementById("btn-coral-to-roman");
  const btnClear = document.getElementById("btn-clear-converter");

  btnR2C.addEventListener("click", () => taCoral.value = romanToCoralStr(taRoman.value));
  btnC2R.addEventListener("click", () => taRoman.value = coralToRomanStr(taCoral.value));
  btnClear.addEventListener("click", () => {
    taRoman.value = "";
    taCoral.value = "";
    taRoman.focus();
  });
}

function escapeHtml(str) {
  return String(str || "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

/* ------------------ Init ------------------ */
document.addEventListener("DOMContentLoaded", () => {
  attachKeyboardHandlers();
  setupSearch();
  setupConverter();
  loadSearchIndex();

  document.getElementById("btn-detail-close").addEventListener("click", () => {
    document.getElementById("detail-panel").style.display = "none";
  });
});
</script>
</body>
</html>
